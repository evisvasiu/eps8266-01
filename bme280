#include <ESP8266WiFi.h>
#include <PubSubClient.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <Ticker.h>
#include "config.h"

ADC_MODE(ADC_VCC);

#define SEALEVELPRESSURE_HPA (1013.25)  //Sea level constant
Adafruit_BME280 bme; // I2C
Ticker ticker;

char temperature[6];
char humidity[6];
char pressure[7];
char vcc[10];

// WiFi
const char *ssid = "Pixel5"; // Enter your WiFi name
const char *password = "tirana2021";  // Enter WiFi password

// MQTT Broker
const char *mqtt_broker = "138.3.246.220";
const char *topic = "esp8266/uv";
const char *mqtt_username = "jezerca";
const char *mqtt_password = "Password@2";
const int mqtt_port = 1883;

WiFiClient espClient;
PubSubClient client(espClient);

void callback(char *topic, byte *payload, unsigned int length) {
  Serial.print("Message arrived in topic: ");
  Serial.println(topic);
  Serial.print("Message:");
  for (int i = 0; i < length; i++) {
      Serial.print((char) payload[i]);
  }
  Serial.println();
  Serial.println("-----------------------");
}

void vccRead() {
  float v  = ESP.getVcc() / 1000.0;
  dtostrf(v, 5, 1, vcc);
}

void setup() {
  // Set software serial baud to 115200;
  Serial.begin(115200);

    Wire.begin(0, 2);
  Wire.setClock(100000);
  if (!bme.begin(0x76)) {
    Serial.println("Could not find a valid BME280 sensor, check wiring!");
    while (1);
  }

  // connecting to a WiFi network
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
      delay(500);
      Serial.println("Connecting to WiFi..");
  }
  Serial.println("Connected to the WiFi network");
  //connecting to a mqtt broker
  client.setServer(mqtt_broker, mqtt_port);
  client.setCallback(callback);
  while (!client.connected()) {
      String client_id = "esp8266-client-";
      client_id += String(WiFi.macAddress());
      Serial.printf("The client %s connects to the public mqtt broker\n", client_id.c_str());
      if (client.connect(client_id.c_str(), mqtt_username, mqtt_password)) {
          Serial.println("Public emqx mqtt broker connected");
      } else {
          Serial.print("failed with state ");
          Serial.print(client.state());
          delay(2000);
      }
  }
  // publish and subscribe
  client.publish(topic, "hello emqx");
  client.subscribe(topic);

  
}

void bmeRead() {
  float t = bme.readTemperature();
  float h = bme.readHumidity();
  float p = bme.readPressure()/100.0F;

  dtostrf(t, 5, 1, temperature);
  dtostrf(h, 5, 1, humidity);
  dtostrf(p, 5, 1, pressure);
}




void loop() {

  bmeRead();
  float bme_t = bme.readTemperature();
  Serial.print("BME Temperature: ");
  Serial.print(bme_t);
  Serial.println("*C");
  client.publish("esp8266/bme_t",temperature);

  float bme_p = bme.readPressure() / 100.0;
  Serial.print("BME Pressure: ");
  Serial.print(bme_p);
  Serial.println("hPa");
  client.publish("esp8266/bme_p", pressure);
  

  float bme_h = bme.readHumidity();
  Serial.print("BME Humidity: ");
  Serial.print(bme_h);
  Serial.print("%");
  Serial.println("\n");
  client.publish("esp8266/bme_h", humidity);
  delay(2000);

    float bme_a = bme.readAltitude(SEALEVELPRESSURE_HPA);
  Serial.print("BME Approx. Altitude: ");
  Serial.print(bme_a);
  Serial.println("m");
  client.publish("esp8266/bme_a", String(bme_a).c_str());

  
}
